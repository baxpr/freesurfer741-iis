# https://github.com/baxpr/freesurfer741-iis
---
procyamlversion: 3.0.0-dev.0

containers:
  - name: freesurfer
    path: freesurfer741-iis_v2.0.2.sif
    source: docker://baxterprogers/freesurfer741-iis:v2.0.2
requirements:
  walltime: 3-0
  memory: 16G
jobtemplate: job_template_v3.txt

inputs:
  xnat:
    
    scans:
      - name: scan_t1
        types: 3D_T1
        skip_unusable: True
        needs_qc: False
        resources:
          - {resource: NIFTI, ftype: FILE, fmatch: '*.nii.gz', fdest: t1.nii.gz}

    assessors:
      - name: assr_fs741
        types: freesurfer741_v2
        resources:
          - {resource: SUBJECT, ftype: DIR}
          - {resource: EDITS, ftype: DIR}

    attrs:
      - {varname: project, object: assessor, attr: project}
      - {varname: subject, object: session, attr: subject_label}
      - {varname: session, object: session, attr: label}
      - {varname: scan, object: scan, attr: ID, ref: scan_t1}

outputs:
  - {path: PDF/Freesurfer-QA.pdf, type: FILE, resource: PDF}
  - {path: PDF_DETAIL, type: DIR, resource: PDF_DETAIL}
  - {path: SUBJECT, type: DIR, resource: SUBJECT}
  - {path: NIFTIS, type: DIR, resource: NIFTIS}
  - {path: MMhippomaps, type: DIR, resource: MMhippomaps}
  - {path: APARCSTATS_BA_exvivo, type: DIR, resource: APARCSTATS_BA_exvivo}
  - {path: APARCSTATS_DKTatlas, type: DIR, resource: APARCSTATS_DKTatlas}
  - {path: APARCSTATS_a2009s, type: DIR, resource: APARCSTATS_a2009s}
  - {path: APARCSTATS_aparc, type: DIR, resource: APARCSTATS_aparc}
  - {path: APARCSTATS_pial, type: DIR, resource: APARCSTATS_pial}
  - {path: VOLSTATS_std, type: DIR, resource: VOLSTATS_std}
  - {path: VOLSTATS_highres, type: DIR, resource: VOLSTATS_highres}
  - {path: SCLIMBIC_QA, type: DIR, resource: SCLIMBIC_QA}

pre:
  type: singularity_exec
  container: freesurfer
  extraopts: --bind /data/mcr/centos7/FS6/license.txt:/usr/local/freesurfer/.license
  args: ->
    bash -c \"
      mv /INPUTS/SUBJECT/SUBJECT /OUTPUTS/SUBJECT &&
      mv /INPUTS/EDITS/EDITS/* /OUTPUTS/SUBJECT/mri &&
      FIXME WE ARE HERE
    \"
  
command: 
  type: singularity_run
  container: freesurfer
  extraopts: --bind /data/mcr/centos7/FS6/license.txt:/usr/local/freesurfer/.license
  args: >-
    --t1_niigz /INPUTS/t1.nii.gz
    --subjects_dir /OUTPUTS
    --label_info "{project} {session} {scan}"
    --out_dir /OUTPUTS
